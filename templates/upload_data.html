{% extends 'base_index.html' %}
{% load static %}

{% block title %}数据上传{% endblock %}

{% block script %}
    <link rel="stylesheet" href="{% static 'kartik-v-bootstrap-fileinput/css/fileinput.css' %}">
    <link rel="stylesheet" href="{% static 'jQuery-Validation-Engine/css/validationEngine.jquery.css' %}">
    <script type="text/javascript" src="{% static 'kartik-v-bootstrap-fileinput/js/fileinput.js' %}"></script>
    <script type="text/javascript" src="{% static 'kartik-v-bootstrap-fileinput/js/locales/zh.js' %}"></script>
    <script type="text/javascript"
            src="{% static 'tableExport.jquery.plugin/libs/js-xlsx/xlsx.full.min.js' %}"></script>
    <script src="{% static 'jQuery-Validation-Engine/js/languages/jquery.validationEngine-en.js' %}"
            type="text/javascript"
            charset="utf-8"></script>
    <script src="{% static 'jQuery-Validation-Engine/js/jquery.validationEngine.js' %}" type="text/javascript"
            charset="utf-8"></script>
    <script src="{% static 'Stuk-jszip-112fcdb/dist/jszip.js' %}"></script>
{% endblock %}

{% block content %}
    <div class="container" style="margin-top: 2%;">

        <div class="row" style="margin-bottom: 2%;">
            <button id="uploadButton" type="button" class="btn btn-lg btn btn-success btn-arrow-right"
                    onclick='window.location.href="{% url 'upload' %}"'>数据上传
            </button>
            <button id="showDataButton" type="button" class="btn btn-lg btn btn-info btn-arrow-right"
                    disabled>数据质量检测
            </button>
            <button id="beginFSButton" type="button" class="btn btn-lg btn btn-info btn-arrow-right"
                    disabled>构效关系建模
            </button>
            <button id="beginMLButton" type="button" class="btn btn-lg btn btn-info btn-arrow-right"
                    disabled>性能预测
            </button>
            <script type="text/javascript">
                let fullUrl = '{{ request.path }}'.substr(1, 100);
                let idfy = fullUrl.substring(0, fullUrl.indexOf('/'));

                console.log(idfy);
                let showDataButton, beginFSButton, beginMLButton;
                showDataButton = document.getElementById('showDataButton');
                beginFSButton = document.getElementById('beginFSButton');
                beginMLButton = document.getElementById('beginMLButton');
                if (idfy === 'qualitycontroltotal') {
                    showDataButton.disabled = true;
                    showDataButton.className += ' btn btn-link';
                    beginFSButton.disabled = false;
                    beginFSButton.className.replace(' btn btn-link', '');
                    beginMLButton.disabled = false;
                    beginMLButton.className.replace(' btn btn-link', '');
                } else if (idfy === 'featureselection') {
                    beginFSButton.disabled = true;
                    beginFSButton.className += ' btn btn-link';
                    showDataButton.disabled = false;
                    showDataButton.className.replace(' btn btn-link', '');
                    beginMLButton.disabled = false;
                    beginMLButton.className.replace(' btn btn-link', '');
                } else if (idfy === 'machinelearning') {
                    beginMLButton.disabled = true;
                    beginMLButton.className += ' btn btn-link';
                    beginFSButton.disabled = false;
                    beginFSButton.className.replace(' btn btn-link', '');
                    showDataButton.disabled = false;
                    showDataButton.className.replace(' btn btn-link', '');
                }
            </script>
        </div>

        <form method="post" enctype="multipart/form-data">{% csrf_token %}
            <div class="accordion" id="accordionExampleOne">
                <div class="card">
                    <div class="card-header" id="headingThree">
                        <h3 class="mb-0">
                            <button class="btn btn-link" type="button" data-toggle="collapse"
                                    data-target="#collapseThree" aria-expanded="true" aria-controls="collapseThree">
                                数据用户信息
                            </button>
                        </h3>
                    </div>
                    <div id="collapseThree" class="collapse show" aria-labelledby="headingThree"
                         data-parent="#accordionExampleOne">
                        <div class="card-body">
                            <div class="form-group">
                                <div class="row">
                                    <label for="submmitter" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">提交者</label>
                                    <div class="form-group col-md-3">
                                        <input type="text"
                                               class="form-control validate[required] validate[maxSize[255]]"
                                               placeholder="提交者" id="submmitter" name="submmitter">
                                    </div>
                                    <label for="submmitter_orgnization" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">所在单位</label>
                                    <div class="form-group col-md-3">
                                        <input type="text"
                                               class="form-control validate[required] validate[maxSize[255]]"
                                               placeholder="所在单位" id="submmitter_orgnization"
                                               name="submmitter_orgnization">
                                    </div>
                                </div>
                                <div class="row">
                                    <label for="proofreader" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">校对者</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]]"
                                               placeholder="校对者" id="proofreader" name="proofreader">
                                    </div>
                                </div>
                                <div class="row">
                                    <label for="submmitter_email" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">邮箱</label>
                                    <div class="form-group col-md-3">
                                        <input value="528241661@qq.com" type="text"
                                               class="form-control validate[required] validate[maxSize[255]] validate[custom[email]]"
                                               placeholder="邮箱" id="submmitter_email" name="submmitter_email">
                                    </div>
                                    <label for="submmitter_phone" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">电话</label>
                                    <div class="form-group col-md-3">
                                        <input value="18321322337" type="text"
                                               class="form-control validate[required] validate[maxSize[255]] validate[custom[phone]]"
                                               placeholder="电话" id="submmitter_phone" name="submmitter_phone">
                                    </div>
                                </div>

                                <div class="row">
                                    <label for="submmitter_address" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">通讯地址</label>
                                    <div class="form-group col-md-3">
                                        <input type="text"
                                               class="form-control validate[required] validate[maxSize[255]]"
                                               placeholder="通讯地址" id="submmitter_address" name="submmitter_address">
                                    </div>
                                </div>
                                <div class="row ">
                                    <div class="formControls col-sm-offset-2 col-sm-2"></div>

                                    <div class="formControls  col-sm-2" style="padding-left: 15px">
                                        <button type="button" class="btn btn-success " onclick="next3()"
                                                style="height: 45px;text-align: center;padding-top: 10px">
                                            下一步 >
                                        </button>
                                    </div>
                                    <script type="text/javascript">
                                        function next3() {
                                            document.getElementById('collapseThree').className = 'collapse';
                                            document.getElementById('collapseFour').className = 'collapse show';
                                        }
                                    </script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="headingFour">
                        <h3 class="mb-0">
                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                    data-target="#collapseFour" aria-expanded="false" aria-controls="collapseFour">
                                数据来源信息
                            </button>
                        </h3>
                    </div>
                    <div id="collapseFour" class="collapse" aria-labelledby="headingFour"
                         data-parent="#accordionExampleOne">
                        <div class="card-body">
                            <div class="form-group">
                                <div class="row">
                                    <label for="div_select" class="col-sm-2  control-label"
                                           style="text-align: right;display: inline-block; height:35px; line-height: 35px">数据分类</label>
                                    <div class="form-group col-md-3">
                                        <span class="select-box radius mt-20" style="margin: 0">
                                            <select id="div_select" class="form-control" size="1" name="div_select">
                                                <option id="exper_opt" value="实验数据" selected>实验数据</option>
                                                <option id="calc_opt" value="计算数据">计算数据</option>
                                                <option id="pred_opt" value="预测数据">预测数据</option>
                                            </select>
                                        </span>
                                    </div>
                                    <label for="eKeyElemColumn" class="col-sm-2 control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">决策属性</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]] "
                                               placeholder="决策属性" id="eKeyElemColumn">
                                    </div>
                                </div>
                                <div class="row">
                                    <label for="eMaterialTrademark" class="col-sm-2 control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">牌号</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]] " placeholder="牌号"
                                               id="eMaterialTrademark">
                                    </div>
                                    <label for="eMName" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">材料名称</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]]"
                                               placeholder="材料名称" id="eMName">
                                    </div>
                                </div>
                                <div class="row">
                                    <label for="expconName" class="col-sm-2 control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">实验条件名称</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]]"
                                               placeholder="实验条件名称" id="expconName">
                                    </div>
                                    <label for="expParasetting" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">实验参数设置</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]]"
                                               placeholder="实验参数设置" id="expParasetting">
                                    </div>
                                </div>
                                <div class="row">
                                    <label for="expDeviceName" class="col-sm-2 control-label"
                                           style="text-align: right;padding-left: 4px; display: inline-block; height:35px; line-height: 35px">实验设备名称与型号</label>
                                    <div class="form-group col-md-3">
                                        <input type="text" class="form-control validate[maxSize[255]]"
                                               placeholder="实验设备名称与型号" id="expDeviceName">
                                    </div>
                                    <label for="div_select1" class="col-sm-2  control-label"
                                           style="text-align: right; display: inline-block; height:35px; line-height: 35px">数据来源</label>
                                    <div class="form-group col-md-3">
                                        <span class="select-box radius mt-20"
                                              style="margin: 0">
                                            <select id="div_select1" class="form-control" size="1" name="div_select1">
                                                <option id="exper_opt1" value="文献" selected>文献</option>
                                                <option id="calc_opt1" value="专利">专利</option>
                                                <option id="pred_opt1" value="其他">其他</option>
                                            </select>
                                        </span>
                                    </div>
                                </div>
                                <div class="row ">
                                    <div class="formControls col-sm-offset-2 col-sm-2"></div>
                                    <div class="formControls col-sm-offset-2 col-sm-2" style="padding-left: 15px">
                                        <button type="button" class="btn btn-success " onclick="prev4()"
                                                style="height: 45px;text-align: center;padding-top: 10px">
                                            < 上一步
                                        </button>
                                    </div>
                                    <div class="formControls  col-sm-2" style="padding-left: 15px">
                                        <button type="button" class="btn btn-success " onclick="next4()"
                                                style="height: 45px;text-align: center;padding-top: 10px">
                                            下一步 >
                                        </button>
                                    </div>
                                    <script type="text/javascript">
                                        function prev4() {
                                            document.getElementById('collapseFour').className = 'collapse';
                                            document.getElementById('collapseThree').className = 'collapse show';
                                        }

                                        function next4() {
                                            document.getElementById('collapseFour').className = 'collapse';
                                            document.getElementById('collapseFive').className = 'collapse show';
                                        }
                                    </script>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header" id="headingFive">
                        <h3 class="mb-0">
                            <button class="btn btn-link collapsed" type="button" data-toggle="collapse"
                                    data-target="#collapseFive" aria-expanded="false" aria-controls="collapseFive">
                                数据基本信息
                            </button>
                        </h3>
                    </div>
                    <div id="collapseFive" class="collapse" aria-labelledby="headingFive"
                         data-parent="#accordionExampleOne">
                        <div class="formControls">
                            <ul class="nav nav-pills nav-justified" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link  active disabled" data-toggle="pill" href="#contentOne"
                                       id="titleOne"
                                       role="tab" aria-controls="contentOne" aria-selected="true">数据集合基本信息</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link disabled" data-toggle="pill" href="#contentTwo" id="titleTwo"
                                       role="tab"
                                       aria-controls="contentTwo" aria-selected="false">样本基本信息</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link disabled" data-toggle="pill" href="#contentThree"
                                       id="titleThree" role="tab" aria-controls="contentThree" aria-selected="false">描述符基本信息</a>
                                </li>
                            </ul>

                            <!-- Tab panes -->
                            <div class="tab-content pb-3 pt-3">
                                <div class="tab-pane container fade show active" id="contentOne" role="tabpanel"
                                     aria-labelledby="contentOne-tab">
                                    <div class="form-group">
                                        <div class="row">
                                            <label for="domainType" class="col-sm-2  control-label"
                                                   style="text-align: right; display: inline-block; height:35px; line-height: 35px">数据领域类型</label>
                                            <div class="form-group col-md-3">
                                                <span class="select-box radius mt-20" style="margin: 0">
                                                    <select id="domainType" class="form-control" size="1"
                                                            name="domainType">
                                                        <option id="li-arg" value="硫银锗矿" selected>硫银锗矿</option>
                                                        <option id="nascion" value="NASCION">NASCION</option>
                                                        <option id="garnet" value="石榴石">石榴石</option>
                                                        <option id="domainOther" value="其他">其他</option>
                                                    </select>
                                                </span>
                                            </div>
                                            <label for="areaType" class="col-sm-2 control-label"
                                                   style="text-align: right; display: inline-block; height:35px; line-height: 35px">方向类型</label>
                                            <div class="form-group col-md-3">
                                                <span class="select-box radius mt-20" style="margin: 0">
                                                    <select id="areaType" class="form-control" size="1" name="areaType">
                                                        <option id="conductivity" value="电导率" selected>电导率</option>
                                                        <option id="activation" value="激活能">激活能</option>
                                                        <option id="areaOther" value="其他">其他</option>
                                                    </select>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <label for="data_keywords" class="col-sm-2  control-label"
                                                   style="text-align: right; display: inline-block; height:35px; line-height: 35px">关键词</label>
                                            <div class="form-group col-md-8">
                                                <input value="NASCION" type="text"
                                                       class="form-control validate[required] validate[maxSize[255]] 	"
                                                       placeholder="关键词(多条用';'分隔)"
                                                       id="data_keywords" name="data_keywords">
                                            </div>
                                        </div>
                                        <div class="row">
                                            <label for="data_abstract" class="col-sm-2 control-label"
                                                   style="text-align: right; display: inline-block; height:35px; line-height: 35px">数据摘要</label>
                                            <div class="form-group col-md-8">
                                                <input type="text" id="data_abstract" name="data_abstract"
                                                       class="form-control validate[maxSize[255]]"
                                                       placeholder="数据摘要">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <label class="col-sm-2  control-label"
                                                   style="text-align: right; display: inline-block; height:35px; line-height: 35px">数据文件上传</label>
                                            <div class="formControls col-md-8">
                                                <input type="file" class="file validate[required]"
                                                       id="input-excel"
                                                       name="input-excel"
                                                       onchange="importExcel(this)"
                                                       placeholder="选上传文件">
                                            </div>
                                            <script type="text/javascript">

                                                let m = 0, n = 0;

                                                function importExcel(obj) {
                                                    console.log('in importexcel');
                                                    console.log(obj.files);
                                                    if (!obj.files) {
                                                        return;
                                                    }
                                                    if (obj.files.length === 0) {
                                                        m = 0;
                                                        n = 0;
                                                        return;
                                                    }
                                                    let f = obj.files[0];
                                                    let r = new FileReader();
                                                    r.readAsBinaryString(f);
                                                    r.onload = function (e) {
                                                        let data = e.target.result;
                                                        let wb = XLSX.read(data, {type: 'binary'});
                                                        let objData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                                        let colnum = 0;
                                                        document.getElementById('data_size_m').value = objData.length;
                                                        m = objData.length;
                                                        let discDiv = $('#descDiv');
                                                        let simpleDiv = $('#sampleDiv');
                                                        discDiv.empty();
                                                        simpleDiv.empty();
                                                        for (let i = 0; i < objData.length; i++) {
                                                            let numTemp = i + 1;
                                                            simpleDiv.append(
                                                                "<div class='row'>" +
                                                                "<div class='col-md-1'></div>" +
                                                                "<div class='form-group col-md-2'>" +
                                                                "<input type='text' id='sampleNum' name='sampleNum'" +
                                                                "class='num form-control validate[required] validate[maxSize[255]]' " +
                                                                "value='" + numTemp + "'>" +
                                                                "</div>" +
                                                                "<div class='form-group col-md-2'>" +
                                                                "<input type='text' id='sampleName' name='sampleName'" +
                                                                "class='form-control validate[required] validate[maxSize[255]]' " +
                                                                "value='unknown'>" +
                                                                "</div>" +
                                                                "<div class='form-group col-md-2'>" +
                                                                "<span class='select-box radius mt-20' " +
                                                                "style='margin: 0'>" +
                                                                "<select class= 'form-control' id='sampleSource' name='sampleSource'>" +
                                                                "<option selected value='unknown'>来源</option>" +
                                                                "<option>数据库</option>" +
                                                                "<option>文献</option>" +
                                                                "<option>生产</option>" +
                                                                "</select>" +
                                                                "</span>" +
                                                                "</div>" +
                                                                "<div class='form-group col-md'><input type='file' class='file input-pdf' " +
                                                                "name='input-pdf' id='input-pdf 'onchange=''>" +
                                                                "</div>" +
                                                                "<script>$('.input-pdf').fileinput({showPreview: false,showRemove: false,browseOnZoneClick: true,allowedFileExtensions: ['pdf'],language: 'zh',type: 'post',theme: 'explorer',browseClass: 'btn btn-info',showUpload: false,browseLabel: '选择文件',msgPlaceholder: '仅支持.pdf格式文件',initialCaption:''})<\/script>" +
                                                                "</div>")
                                                        }
                                                        for (let colname in objData[0]) {
                                                            if (objData[0].hasOwnProperty(colname)) {
                                                                colnum += 1;
                                                                discDiv.append(
                                                                    "<div class='row'>" +
                                                                    "<div class='col-md-1'></div>" +
                                                                    "<div class='form-group col-md-2'>" +
                                                                    "<input type='text' " +
                                                                    "class='form-control validate[required] validate[maxSize[255]]' id='dimName'" +
                                                                    "value='" + colname + "'>" +
                                                                    "</div>" +
                                                                    "<div class='form-group col-md-2'>" +
                                                                    "<span class='select-box radius mt-20' " +
                                                                    "style='margin: 0'>" +
                                                                    "<select class= 'form-control ' name='dataType'>" +
                                                                    "<option selected value='unknown'>数据类型</option>" +
                                                                    "<option class='int' value= 'Int'>Int</option>" +
                                                                    "<option class='float' value= 'Float'>Float</option>" +
                                                                    "</select>" +
                                                                    "</span>" +
                                                                    "</div>" +
                                                                    "<div class='form-group col-md-2'>" +
                                                                    "<input type='text' id='dimRange' name='dimRange' " +
                                                                    "class='form-control validate[required] validate[maxSize[255]]' " +
                                                                    "placeholder='2,3' >" +
                                                                    "</div>" +
                                                                    "<div class='form-group col-md-4'>" +
                                                                    "<input type='text' id='dimDesc' name='dimDesc' " +
                                                                    "class='form-control validate[required] validate[maxSize[255]]' " +
                                                                    "placeholder='描述信息' >" +
                                                                    "</div>" +
                                                                    "</div>");
                                                            }
                                                        }
                                                        document.getElementById('data_size_n').value = colnum;
                                                        n = colnum;
                                                        //console.log(simpleDiv.find('.file.input-pdf').attr('class'));
                                                    }
                                                }
                                            </script>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-2"></div>
                                            <label class="control-label"
                                                   style="text-align: center; padding-left: 10px">
                                                *支持的文件扩展名：.xls，.xlsx（Excel表格文件）
                                            </label>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-2"></div>
                                            <label class="control-label"
                                                   style="text-align: center; padding-left: 10px">
                                                *文件格式说明：表格第一行应为特征名，最后一列为目标属性，务必确保所有属性值不为空
                                            </label>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-2"></div>
                                            <label class="control-label"
                                                   style="text-align: center; padding-left: 10px">
                                                *描述文件为数据文件样本的描述信息
                                            </label>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-2"></div>
                                            <label class="control-label"
                                                   style="text-align: center; padding-left: 10px">
                                                <a href="{% url 'download_example' 'NASICON-data.xlsx' %}">数据文件示例</a>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <label for="data_size_m" class="col-sm-2 control-label"
                                               style="text-align: right; display: inline-block; height:35px; line-height: 35px">样本数</label>
                                        <div class="form-group col-md-3">
                                            <input type="text"
                                                   class="form-control validate[required] validate[custom[number]] validate[maxSize[10]]"
                                                   placeholder="*" id="data_size_m" name="data_size_m">
                                        </div>
                                        <label for="data_size_n" class="col-sm-2 control-label"
                                               style="text-align: right; display: inline-block; height:35px; line-height: 35px">维度</label>
                                        <div class="form-group col-md-3">
                                            <input type="text"
                                                   class="form-control validate[required] validate[custom[number]] validate[maxSize[10]]"
                                                   placeholder="*" id="data_size_n" name="data_size_n">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="formControls col-sm-offset-2 col-sm-2"></div>
                                        <div class="formControls  col-sm-2" style="padding-left: 15px">
                                            <button type="button" class="btn btn-success" onclick="next1()"
                                                    style="height: 45px;text-align: center;padding-top: 10px">
                                                下一步 >
                                            </button>
                                            <script type="text/javascript">
                                                function next1() {
                                                    if (m === 0 && n === 0) {
                                                        alert("未上传数据文件");
                                                    } else {
                                                        if (document.getElementById('data_size_m').value !== String(m) || document.getElementById('data_size_n').value !== String(n)) {
                                                            let result = confirm('样本数或维度与上述文件不符，确定继续吗？');
                                                            if (result === true) {
                                                                document.getElementById('titleOne').className = 'nav-link';
                                                                document.getElementById('titleTwo').className = 'nav-link  active';
                                                                document.getElementById('contentOne').className = 'tab-pane container';
                                                                document.getElementById('contentTwo').className = 'tab-pane container active';
                                                            }
                                                        } else {
                                                            document.getElementById('titleOne').className = 'nav-link';
                                                            document.getElementById('titleTwo').className = 'nav-link  active';
                                                            document.getElementById('contentOne').className = 'tab-pane container';
                                                            document.getElementById('contentTwo').className = 'tab-pane container active';
                                                        }
                                                    }
                                                }
                                            </script>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane container fade" id="contentTwo" role="tabpanel"
                                     aria-labelledby="contentTwo-tab">
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <div class="formControls col-md-2 py-0"
                                                 style="display: inline-block; height:35px; line-height: 35px;">
                                                <span class="select-box radius mt-20"
                                                      style="margin: 0">
                                                    <select class="form-control" id="count">
                                                        <option selected>编号</option>
                                                        <option>自动编号</option>
                                                    </select>
                                                </span>
                                                <script>
                                                    function automaticNumbering() {
                                                        let temp = $('#sampleDiv .num');
                                                        for (let i in temp) {
                                                            temp.eq(i).val(String(Number(i) + 1));
                                                        }
                                                    }

                                                    $(function () {
                                                        $('#count').change(function () {
                                                            if ($('#count').val() === '自动编号') {
                                                                automaticNumbering();
                                                            }
                                                        });
                                                    });
                                                </script>
                                            </div>
                                            <label class="col-md-2 control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">名称</label>
                                            <div class="col-md-2"
                                                 style="display: inline-block; height:35px; line-height: 35px;">
                                            <span class="select-box radius mt-20"
                                                  style="margin: 0">
                                                 <select class="form-control" id="sampleSource">
                                                     <option selected value='unknown'>来源</option>
                                                     <option>数据库</option>
                                                     <option>文献</option>
                                                     <option>生产</option>
                                                 </select>
                                            </span>
                                                <script>
                                                    $(function () {
                                                        $('#sampleSource').change(function () {
                                                            $('#sampleDiv select').val($('#sampleSource option:selected').val());
                                                        });
                                                    });
                                                </script>
                                            </div>
                                            <label class="col-md-4 control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">相关文献</label>
                                        </div>
                                        <div id="sampleDiv"
                                             style="height: 600px;overflow-y: scroll;overflow-x: hidden"></div>
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <label class="col-md-2  control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">编号和名称批量上传</label>
                                            <div class="formControls col-md-7">
                                                <input type="file" class="file validate[required] input-excel"
                                                       id="input-excel-numAndName"
                                                       name="input-excel-numAndName"
                                                       onchange="importExcelNumAndName(this)">
                                            </div>
                                            <script>
                                                function importExcelNumAndName(obj) {
                                                    console.log('in importExcelNumAndName');
                                                    console.log(obj.files);
                                                    if (!obj.files) {
                                                        return;
                                                    }
                                                    let f = obj.files[0];
                                                    let r = new FileReader();
                                                    r.readAsBinaryString(f);
                                                    r.onload = function (e) {
                                                        let data = e.target.result;
                                                        let wb = XLSX.read(data, {type: 'binary'});
                                                        let objData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                                        let simpleDiv = $('#sampleDiv>div.row');
                                                        for (let i = 0; i < objData.length; i++) {
                                                            simpleDiv.eq(i).find('#sampleNum').val(objData[i].编号);
                                                            simpleDiv.eq(i).find('#sampleName').val(objData[i].名称);
                                                        }
                                                    }
                                                }
                                            </script>
                                            <div class="col-sm-2">
                                                <label class="control-label"
                                                       style="text-align: center; padding: 10px">
                                                    <a href="{% url 'download_example' 'sample-basic-info.xlsx' %}">文件示例</a>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <label class="col-md-2  control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">相关文献的批量上传</label>
                                            <div class="formControls col-md-7">
                                                <input type="file" class="file validate[required]"
                                                       id="input-zip"
                                                       name="input-zip"
                                                       onchange="importZip(this)" disabled>
                                            </div>
                                            <script>
                                                function importZip(obj) {
                                                    console.log('in importZip');
                                                    console.log(obj.files);
                                                    if (!obj.files) {
                                                        return;
                                                    }
                                                    let f = obj.files[0];
                                                    let sampleDiv = $('#sampleDiv>div.row');
                                                    //console.log($('#input-zip').val());
                                                    JSZip.loadAsync(f).then(function (zip) {
                                                        for (let i = 0; i < sampleDiv.length; i++) {
                                                            let num = sampleDiv.find('#sampleNum').eq(i).val();
                                                            let re = new RegExp(".*" + num + ".*");
                                                            try {
                                                                let filex = zip.file(re)[0];
                                                                //console.log(filex.name);
                                                                let j = i + 1;
                                                                let elem = sampleDiv.find('#input-pdf' + j);
                                                                let par = elem.parent();
                                                                console.log(elem.prop('tagName'));
                                                                //elem.prop('hidden',true);
                                                                //elem.remove();
                                                                /*$('.input-pdf').fileinput({
                                                                    showPreview: false,
                                                                    showRemove: false,
                                                                    browseOnZoneClick: true,
                                                                    allowedFileExtensions: ['pdf'],
                                                                    language: 'zh',
                                                                    type: 'post',
                                                                    theme: 'explorer',
                                                                    browseClass: 'btn btn-info',
                                                                    showUpload: false,
                                                                    browseLabel: '选择文件',
                                                                    msgPlaceholder: '仅支持.pdf格式文件',
                                                                    initialCaption: filex.name,
                                                                })
                                                                let newElem="<input type='file' class='file input-pdf' name='input-pdf' id='input-pdf' onchange=''>";
                                                                par.html(newElem);*/
                                                                //
                                                                //console.log(sampleDiv.find('#input-pdf' + j));
                                                                //sampleDiv.find('#input-pdf' + j).prop('data-initial-caption', filex.name);
                                                                //console.log(sampleDiv.find('#input-pdf' + j).prop('data-initial-caption'));

                                                            } catch (e) {

                                                            }
                                                        }

                                                    })
                                                }
                                            </script>

                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="formControls col-sm-offset-2 col-sm-2"></div>
                                        <div class="formControls  col-sm-2" style="padding-left: 15px">
                                            <button type="button" class="btn btn-success" onclick="next2()"
                                                    style="height: 45px;text-align: center;padding-top: 10px">
                                                下一步 >
                                            </button>
                                        </div>
                                        <script type="text/javascript">
                                            function next2() {
                                                document.getElementById('titleTwo').className = 'nav-link';
                                                document.getElementById('titleThree').className = 'nav-link  active';
                                                document.getElementById('contentTwo').className = 'tab-pane container';
                                                document.getElementById('contentThree').className = 'tab-pane container active';
                                            }
                                        </script>
                                    </div>
                                </div>
                                <div class="tab-pane container fade" id="contentThree" role="tabpanel"
                                     aria-labelledby="contentThree-tab">
                                    <div class="form-group">
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <label class="col-md-2 control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">名称</label>
                                            <div class="col-md-2"
                                                 style="display: inline-block; height:35px; line-height: 35px;">
                                             <span class="select-box radius mt-20"
                                                   style="margin: 0">
                                                 <select class="form-control" id="titleBox">
                                                    <option selected value='unknown'>数据类型</option>
                                                    <option class="int" value="Int">Int</option>
                                                    <option class="float" value="Float">Float</option>
                                                 </select>
                                             </span>
                                                <script>
                                                    $(function () {
                                                        $('#titleBox').change(function () {
                                                            $('#descDiv select').val($('#titleBox option:selected').val());
                                                        });
                                                    });
                                                </script>
                                            </div>
                                            <label class="col-md-2 control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">取值范围(min-max)</label>
                                            <label class="col-md-4 control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">描述信息</label>
                                            {# TODO: 值域 #}
                                        </div>
                                        <div id="descDiv"
                                             style="height: 600px;overflow-y: scroll;overflow-x: hidden"></div>
                                        <div class="row">
                                            <div class="col-md-1"></div>
                                            <label class="col-md-2  control-label"
                                                   style="display: inline-block; height:35px; line-height: 35px">基本信息批量上传</label>
                                            <div class="formControls col-md-7">
                                                <input type="file" class="file validate[required] input-excel"
                                                       id="input-excel-basic"
                                                       name="input-excel-basic"
                                                       onchange="importExcelBasic(this)"
                                                       placeholder="选上传文件">
                                            </div>
                                            <script>
                                                function importExcelBasic(obj) {
                                                    console.log('in importExcelBasic');
                                                    console.log(obj.files);
                                                    if (!obj.files) {
                                                        return;
                                                    }
                                                    let f = obj.files[0];
                                                    let r = new FileReader();
                                                    r.readAsBinaryString(f);
                                                    r.onload = function (e) {
                                                        let data = e.target.result;
                                                        let wb = XLSX.read(data, {type: 'binary'});
                                                        let objData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                                                        let discDiv = $('#descDiv>div.row');
                                                        for (let i = 0; i < objData.length; i++) {
                                                            discDiv.eq(i).find('#dimName').val(objData[i].名称);
                                                            discDiv.eq(i).find('select').val(objData[i].数据类型);
                                                            discDiv.eq(i).find('#dimRange').val(objData[i].取值范围);
                                                            discDiv.eq(i).find('#dimDesc').val(objData[i].描述信息);
                                                        }
                                                    }
                                                }
                                            </script>
                                            <div class="col-sm-2">
                                                <label class="control-label"
                                                       style="text-align: center; padding: 10px">
                                                    <a href="{% url 'download_example' 'descriptors-basic-info.xlsx' %}">文件示例</a>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row ">
                                        <div class="formControls col-sm-offset-2 col-sm-2"></div>
                                        <div class="formControls  col-sm-2" style="padding-left: 15px">
                                            <button type="submit" class="btn btn-success "
                                                    style="height: 45px;text-align: center;padding-top: 10px">
                                                下一步 >
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>

    <script>
        $('#input-excel').fileinput({
            showPreview: false,
            showRemove: false,
            browseOnZoneClick: true,
            allowedFileExtensions: ['xls', 'xlsx'],
            language: 'zh',
            type: 'post',
            theme: 'explorer',
            browseClass: 'btn btn-info',
            showUpload: false,
            browseLabel: '选择文件',
            msgPlaceholder: '*选择文件',
        })
        $('#input-excel-desc').fileinput({
            showPreview: false,
            showRemove: false,
            browseOnZoneClick: true,
            allowedFileExtensions: ['xls', 'xlsx'],
            language: 'zh',
            type: 'post',
            theme: 'explorer',
            browseClass: 'btn btn-info',
            showUpload: false,
            browseLabel: '选择文件',
            msgPlaceholder: '  选择文件',
        })
        $('.input-excel').fileinput({
            showPreview: false,
            showRemove: false,
            browseOnZoneClick: true,
            allowedFileExtensions: ['xls', 'xlsx'],
            language: 'zh',
            type: 'post',
            theme: 'explorer',
            browseClass: 'btn btn-info',
            showUpload: false,
            browseLabel: '选择文件',
            msgPlaceholder: '仅支持.xls和.xlsx格式文件',
        })
        $('#input-zip').fileinput({
            showPreview: false,
            showRemove: false,
            browseOnZoneClick: true,
            allowedFileExtensions: ['zip'],
            language: 'zh',
            type: 'post',
            theme: 'explorer',
            browseClass: 'btn btn-info',
            showUpload: false,
            browseLabel: '选择文件',
            msgPlaceholder: '仅支持.zip格式文件',
        })
        /*$('.input-pdf').fileinput({
            showPreview: false,
            showRemove: false,
            browseOnZoneClick: true,
            allowedFileExtensions: ['pdf'],
            language: 'zh',
            type: 'post',
            theme: 'explorer',
            browseClass: 'btn btn-info',
            showUpload: false,
            browseLabel: '选择文件',
            msgPlaceholder: '仅支持.pdf格式文件',
        })*/
    </script>
{% endblock %}